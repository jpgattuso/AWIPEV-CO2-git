"0","d <- read.table(paste0(path, ""fb_data/Discrete_analyses_AT_CT/Discrete_sampling_AWIPEV.csv""), header = T, dec = ""."", as.is = T, sep = "";"", fill = TRUE)"
"0","d$datetime <- as.POSIXct(d$sampling_date, format=""%d/%m/%Y %H:%M"", tz=""UTC"")"
"0","d$measure_date <- dmy(d$measure_date, tz=""UTC"")"
"0","# Add the flag location: some samples have been collected at the peer. Notes them here."
"0","# Flag 1 = collected on the peer by Niskin and flag 0 = collected in the FB (normal collect)"
"0"," # And keep data with flag 0 for FB location"
"0","d <- d%>%"
"0","  dplyr::mutate(location_flag = ifelse(datetime == ""2016-04-21 09:25:00"" | datetime == ""2016-02-10 14:00:00"" | datetime == ""2016-02-17 09:20:00"" |datetime == ""2016-02-24 14:20:00"" | datetime == ""2016-02-04 09:30:00"" |datetime == ""2016-01-27 15:00:00"" |datetime == ""2016-01-13 13:45:00"" |datetime == ""2016-01-06 14:10:00"" |datetime == ""2015-12-24 10:45:00"" |datetime == ""2015-12-30 13:30:00"" |datetime == ""2018-01-05 15:20:00"" |datetime == ""2018-02-02 14:35:00""|datetime == ""2018-03-02 14:10:00"", 1,0)"
"0","  )"
"0","d <- d%>%"
"0","  dplyr::filter(location_flag== 0)"
"0","# Keep only flag = 2 for at/ct analysis "
"0","# Keep only flag = 2 for pH durafet and seaFET."
"0","d <- d%>%"
"0","  dplyr::mutate(ct= replace(ct, qflag_ct != 2, NA),"
"0","                at= replace(at, qflag_at != 2, NA),"
"0","                pH_s_seafet= replace(pH_s_seafet, qflag_pH_s_seafet != 2, NA),"
"0","                pH_s_durafet= replace(pH_s_durafet, qflag_pH_s_durafet != 2, NA))"
"0","# Mercury chloride correction (Dickson et al. 2007, SOP3a)"
"0","# AT"
"0","d$at <- d$at * 1.0002"
"0","#CT"
"0","d$ct <- d$ct * 1.0002"
"0","# Fill ""at/ct"" to all line with same day."
"0","at_ct_mean <- d %>% "
"0","  group_by(datetime)%>%"
"0","  dplyr::summarize(at_mean = mean(at, na.rm = T),"
"0","                   ct_mean = mean(ct, na.rm = T),"
"0","                   at_sd = sd(at, na.rm = T), "
"0","                   ct_sd = sd(ct, na.rm = T)"
"0","                   )"
"0","d <- left_join(d, at_ct_mean, by='datetime')"
"0","# Fill the gaps in at_mean with interpolation"
"0","TAinterp <-approx(d$datetime, d$at_mean, xout=d$datetime, method=""linear"", rule=2)"
"0","names(TAinterp) <- c(""datetime"", ""at_mean_interp"")"
"0","TAinterp <- as.data.frame(TAinterp)"
"0","d$at_mean_interp <- TAinterp$at_mean_interp"
"0","CTinterp <-approx(d$datetime, d$ct_mean, xout=d$datetime, method=""linear"", rule=2)"
"0","names(CTinterp) <- c(""datetime"", ""ct_mean_interp"")"
"0","CTinterp <- as.data.frame(CTinterp)"
"0","d$ct_mean_interp <- CTinterp$ct_mean_interp"
"0","# Conversion of spectro pH to a same TÂ°"
"0","pH_seafet <- d %>%"
"0","  dplyr::filter(!is.na(pH_s_seafet))"
"0","pH_seafet <- pH_seafet %>%"
"0","  dplyr::mutate(pH_s_seafet_temp_field = pHinsi(pH=pH_seafet$pH_s_seafet,ALK=pH_seafet$at_mean_interp*1e-6, Tinsi=pH_seafet$temp_field, Tlab=pH_seafet$temp_s_lab, Pinsi= pH_seafet$depth/10, S=pH_seafet$salinity_field,Pt=0,Sit=0))"
"0","                "
"0","pH_durafet <- d %>%"
"0","  dplyr::filter(!is.na(pH_s_durafet))"
"0","pH_durafet <- pH_durafet %>%"
"0","  dplyr::mutate(pH_s_durafet_temp_field = pHinsi(pH=pH_durafet$pH_s_durafet,ALK=pH_durafet$at_mean_interp*1e-6, Tinsi=pH_durafet$temp_field, Tlab=pH_durafet$temp_s_lab, Pinsi= pH_durafet$depth/10, S=pH_durafet$salinity_field,Pt=0,Sit=0))"
"0"," "
"0","# create separate seafet/durafet df to join to initial ""d"" df"
"0","pH_seafet_mean <- pH_seafet%>%"
"0","  dplyr::select(datetime,pH_s_seafet_temp_field)%>% "
"0","  dplyr::group_by(datetime) %>% "
"0","  dplyr::summarize(pH_s_seafet_temp_field = mean(pH_s_seafet_temp_field, na.rm = T))"
"0","pH_durafet_mean <- pH_durafet%>%"
"0","  dplyr::select(datetime,pH_s_durafet_temp_field)%>% "
"0","  dplyr::group_by(datetime) %>% "
"0","  dplyr::summarize(pH_s_durafet_temp_field = mean(pH_s_durafet_temp_field, na.rm = T))"
"0","#  make means in ""d"" to have same format and call it ""discrete"""
"0","discrete <- d %>% "
"0","  dplyr::group_by(datetime) %>% "
"0","  dplyr::summarize(sal = mean(salinity_field, na.rm = T),"
"0","            temp = mean(temp_field, na.rm = T),"
"0","            at_mean_interp = mean(at_mean_interp, na.rm = T),"
"0","            at = mean(at, na.rm = T),"
"0","            qflag_at = mean(qflag_at, na.rm = T),"
"0","            ct_mean_interp = mean(ct_mean_interp, na.rm = T),"
"0","            ct = mean(ct, na.rm = T),"
"0","            qflag_ct = mean(qflag_ct, na.rm = T)"
"0","            )"
"0","# join discrete + seafet/durafet"
"0","discrete <- left_join(discrete, pH_seafet_mean, by='datetime')"
"0","discrete <- left_join(discrete, pH_durafet_mean, by='datetime')"
"0","##   *****Attention, temp noted by logisticians in d is FB temp with SBE45 ******"
"0","# discrete_steffen <- discrete[c(21:72),1:4]"
"0","# write.table( discrete_steffen,""../fb_data/DiscreteTA_for_steffen.txt"", sep= "","", dec=""."", row.names = FALSE)"
"0","carb <- carb(15, discrete$at*1e-6, discrete$ct*1e-6,S=discrete$sal, T=discrete$temp, P=0, Pt=0, Sit=0,k1k2=""l"", kf=""dg"", ks=""d"", pHscale=""T"", b=""u74"")"
"0","discrete$phcalc<- carb$pH"
"0","discrete$pco2calc<- carb$pCO2"
